{"version":3,"file":"background.js","sources":["../src/background.ts"],"sourcesContent":["const LOG_PREFIX = \"[Imagion Background]\";\r\nconst DEFAULT_DETECTION_ENDPOINT = \"http://localhost:3000/api/detect\";\r\nconst REQUEST_TTL_MS = 5 * 60 * 1000;\r\nconst MAX_CONCURRENT_DETECTIONS = 3;\r\nconst TELEMETRY_KEY = \"imagionTelemetry\";\r\nconst TELEMETRY_LIMIT = 40;\r\nconst BACKOFF_MIN_MS = 15000;\r\nconst BACKOFF_MAX_MS = 60000;\r\n\r\nconsole.log(LOG_PREFIX, \"Service worker started\");\r\n\r\ntype ImagionConfig = {\r\n  imagionApiKey: string;\r\n  imagionDetectionEndpoint: string;\r\n};\r\n\r\ntype DetectionResponsePayload = {\r\n  status: \"success\" | \"missing-key\" | \"error\" | \"rate-limit\";\r\n  verdict?: string;\r\n  score?: number;\r\n  confidence?: number;\r\n  presentation?: string;\r\n  message?: string;\r\n  retryAfterSeconds?: number;\r\n};\r\n\r\ntype DetectionResponse = DetectionResponsePayload & {\r\n  badgeId: string;\r\n  imageUrl: string;\r\n};\r\n\r\ntype PendingResolver = {\r\n  badgeId: string;\r\n  sendResponse: (response: DetectionResponse) => void;\r\n};\r\n\r\ntype PendingRequest = {\r\n  resolvers: PendingResolver[];\r\n};\r\n\r\ntype TelemetryEntry = {\r\n  timestamp: number;\r\n  level: \"info\" | \"warning\" | \"error\";\r\n  message: string;\r\n  details?: Record<string, unknown>;\r\n};\r\n\r\nconst cache = new Map<string, { timestamp: number; payload: DetectionResponsePayload }>();\r\nconst pendingRequests = new Map<string, PendingRequest>();\r\nconst detectionQueue: Array<{ imageUrl: string }> = [];\r\nconst telemetryEntries: TelemetryEntry[] = [];\r\nlet runningDetections = 0;\r\nlet cachedConfig: ImagionConfig | null = null;\r\nlet nextAllowedTimestamp = 0;\r\nlet backoffTimer: ReturnType<typeof setTimeout> | null = null;\r\n\r\nasync function getConfig(): Promise<ImagionConfig> {\r\n  if (cachedConfig) {\r\n    return cachedConfig;\r\n  }\r\n\r\n  const config = await new Promise<ImagionConfig>((resolve) => {\r\n    chrome.storage.local.get(\r\n      {\r\n        imagionApiKey: \"\",\r\n        imagionDetectionEndpoint: DEFAULT_DETECTION_ENDPOINT,\r\n      },\r\n      (items) => {\r\n        resolve({\r\n          imagionApiKey: typeof items.imagionApiKey === \"string\" ? items.imagionApiKey.trim() : \"\",\r\n          imagionDetectionEndpoint:\r\n            typeof items.imagionDetectionEndpoint === \"string\" && items.imagionDetectionEndpoint.trim().length > 0\r\n              ? items.imagionDetectionEndpoint.trim()\r\n              : DEFAULT_DETECTION_ENDPOINT,\r\n        });\r\n      }\r\n    );\r\n  });\r\n\r\n  cachedConfig = config;\r\n  console.log(LOG_PREFIX, \"Config loaded:\", {\r\n    hasApiKey: !!config.imagionApiKey,\r\n    endpoint: config.imagionDetectionEndpoint,\r\n  });\r\n  return config;\r\n}\r\n\r\nchrome.storage.onChanged.addListener((changes, areaName) => {\r\n  if (areaName !== \"local\") {\r\n    return;\r\n  }\r\n  if (changes.imagionApiKey || changes.imagionDetectionEndpoint) {\r\n    console.log(LOG_PREFIX, \"Config changed, clearing cache\");\r\n    cachedConfig = null;\r\n  }\r\n});\r\n\r\nchrome.runtime.onMessage.addListener((message, _sender, sendResponse) => {\r\n  if (!message || message.type !== \"REQUEST_DETECTION\") {\r\n    return false;\r\n  }\r\n\r\n  console.log(LOG_PREFIX, \"Received detection request:\", message.badgeId, message.imageUrl?.substring(0, 80));\r\n  handleImageDetection(message, sendResponse);\r\n  return true;\r\n});\r\n\r\nfunction handleImageDetection(message: {\r\n  type: \"REQUEST_DETECTION\";\r\n  imageUrl: string;\r\n  badgeId: string;\r\n  pageUrl: string;\r\n}, sendResponse: (response: DetectionResponse) => void) {\r\n  const normalizedUrl = normalizeImageUrl(message.imageUrl, message.pageUrl);\r\n  if (!normalizedUrl) {\r\n    console.warn(LOG_PREFIX, \"Invalid URL:\", message.imageUrl);\r\n    sendResponse({\r\n      status: \"error\",\r\n      message: \"Unable to resolve image URL.\",\r\n      badgeId: message.badgeId,\r\n      imageUrl: message.imageUrl,\r\n    });\r\n    return;\r\n  }\r\n\r\n  const cached = getCachedResult(normalizedUrl);\r\n  if (cached) {\r\n    console.log(LOG_PREFIX, \"Cache hit for:\", message.badgeId);\r\n    sendResponse({ ...cached, badgeId: message.badgeId, imageUrl: normalizedUrl });\r\n    return;\r\n  }\r\n\r\n  const existing = pendingRequests.get(normalizedUrl);\r\n  if (existing) {\r\n    console.log(LOG_PREFIX, \"Joining existing request for:\", message.badgeId);\r\n    existing.resolvers.push({ badgeId: message.badgeId, sendResponse });\r\n    return;\r\n  }\r\n\r\n  console.log(LOG_PREFIX, \"Queueing new request for:\", message.badgeId);\r\n  pendingRequests.set(normalizedUrl, { resolvers: [{ badgeId: message.badgeId, sendResponse }] });\r\n  detectionQueue.push({ imageUrl: normalizedUrl });\r\n  processQueue();\r\n}\r\n\r\nfunction normalizeImageUrl(imageUrl: string, pageUrl: string): string | null {\r\n  if (!imageUrl) {\r\n    return null;\r\n  }\r\n  try {\r\n    return new URL(imageUrl, pageUrl || undefined).toString();\r\n  } catch (error) {\r\n    console.warn(LOG_PREFIX, \"Invalid image URL\", imageUrl, error);\r\n    return null;\r\n  }\r\n}\r\n\r\nfunction getCachedResult(imageUrl: string): DetectionResponsePayload | null {\r\n  const entry = cache.get(imageUrl);\r\n  if (!entry) {\r\n    return null;\r\n  }\r\n  if (Date.now() - entry.timestamp > REQUEST_TTL_MS) {\r\n    cache.delete(imageUrl);\r\n    return null;\r\n  }\r\n  return entry.payload;\r\n}\r\n\r\nfunction processQueue() {\r\n  if (Date.now() < nextAllowedTimestamp) {\r\n    console.log(LOG_PREFIX, \"Rate limited, waiting...\");\r\n    return;\r\n  }\r\n\r\n  while (runningDetections < MAX_CONCURRENT_DETECTIONS && detectionQueue.length > 0) {\r\n    const job = detectionQueue.shift();\r\n    if (!job) {\r\n      continue;\r\n    }\r\n    runningDetections += 1;\r\n    console.log(LOG_PREFIX, `Processing queue (${runningDetections}/${MAX_CONCURRENT_DETECTIONS} running, ${detectionQueue.length} pending)`);\r\n\r\n    runDetection(job.imageUrl)\r\n      .catch(() => {\r\n        // Individual errors are handled inside runDetection.\r\n      })\r\n      .finally(() => {\r\n        runningDetections -= 1;\r\n        processQueue();\r\n      });\r\n  }\r\n}\r\n\r\nasync function runDetection(imageUrl: string) {\r\n  const { imagionApiKey, imagionDetectionEndpoint } = await getConfig();\r\n\r\n  if (!imagionApiKey) {\r\n    console.warn(LOG_PREFIX, \"No API key configured\");\r\n    recordTelemetry({\r\n      level: \"warning\",\r\n      message: \"missing_api_key\",\r\n      details: { imageUrl },\r\n    });\r\n    dispatchResponse(imageUrl, {\r\n      status: \"missing-key\",\r\n      message: \"Please provide an Imagion API key in the options page.\",\r\n    });\r\n    return;\r\n  }\r\n\r\n  let blob: Blob;\r\n  try {\r\n    console.log(LOG_PREFIX, \"Fetching image:\", imageUrl.substring(0, 80));\r\n    blob = await fetchImageBytes(imageUrl);\r\n    console.log(LOG_PREFIX, \"Image fetched, size:\", blob.size, \"bytes\");\r\n  } catch (error) {\r\n    console.error(LOG_PREFIX, \"Failed to fetch image:\", error);\r\n    recordTelemetry({\r\n      level: \"error\",\r\n      message: \"fetch_image_failed\",\r\n      details: { imageUrl, error: error instanceof Error ? error.message : String(error) },\r\n    });\r\n    dispatchResponse(imageUrl, {\r\n      status: \"error\",\r\n      message: error instanceof Error ? error.message : \"Unable to fetch the image.\",\r\n    });\r\n    return;\r\n  }\r\n\r\n  const formData = new FormData();\r\n  const fileName = extractFileName(imageUrl);\r\n  const file = new File([blob], fileName, { type: blob.type || \"image/jpeg\" });\r\n  formData.append(\"file\", file);\r\n\r\n  let response: Response;\r\n  try {\r\n    console.log(LOG_PREFIX, \"Sending to API:\", imagionDetectionEndpoint);\r\n    response = await fetch(imagionDetectionEndpoint, {\r\n      method: \"POST\",\r\n      headers: {\r\n        \"x-api-key\": imagionApiKey,\r\n      },\r\n      body: formData,\r\n    });\r\n    console.log(LOG_PREFIX, \"API response status:\", response.status);\r\n  } catch (error) {\r\n    console.error(LOG_PREFIX, \"API request failed:\", error);\r\n    recordTelemetry({\r\n      level: \"error\",\r\n      message: \"detection_request_failed\",\r\n      details: { imageUrl, error: error instanceof Error ? error.message : String(error) },\r\n    });\r\n    dispatchResponse(imageUrl, {\r\n      status: \"error\",\r\n      message: error instanceof Error ? error.message : \"Detection request failed.\",\r\n    });\r\n    return;\r\n  }\r\n\r\n  let payload: unknown;\r\n  try {\r\n    payload = await response.json();\r\n    console.log(LOG_PREFIX, \"API response payload:\", payload);\r\n  } catch (error) {\r\n    console.error(LOG_PREFIX, \"Failed to parse JSON:\", error);\r\n    recordTelemetry({\r\n      level: \"error\",\r\n      message: \"invalid_json\",\r\n      details: { imageUrl, error: error instanceof Error ? error.message : String(error) },\r\n    });\r\n    dispatchResponse(imageUrl, {\r\n      status: \"error\",\r\n      message: error instanceof Error ? error.message : \"Unable to parse detection response.\",\r\n    });\r\n    return;\r\n  }\r\n\r\n  if (response.status === 429) {\r\n    const retryAfter = parseRetryAfter(response.headers.get(\"Retry-After\"));\r\n    applyRateLimitBackoff(retryAfter);\r\n    console.warn(LOG_PREFIX, \"Rate limited, retry after:\", retryAfter, \"seconds\");\r\n    recordTelemetry({\r\n      level: \"warning\",\r\n      message: \"rate_limited\",\r\n      details: { imageUrl, retryAfter },\r\n    });\r\n    dispatchResponse(imageUrl, {\r\n      status: \"rate-limit\",\r\n      message: `Rate limit exceeded. Retrying in ${retryAfter} seconds.`,\r\n      retryAfterSeconds: retryAfter,\r\n    });\r\n    return;\r\n  }\r\n\r\n  if (!response.ok) {\r\n    const message = (payload as { message?: string })?.message || \"Detection failed\";\r\n    console.error(LOG_PREFIX, \"API error:\", response.status, message);\r\n    recordTelemetry({\r\n      level: \"error\",\r\n      message: \"detection_error\",\r\n      details: { imageUrl, responseStatus: response.status, message },\r\n    });\r\n    dispatchResponse(imageUrl, {\r\n      status: \"error\",\r\n      message,\r\n    });\r\n    return;\r\n  }\r\n\r\n  const structuredPayload = payload as {\r\n    verdict?: string;\r\n    score?: number;\r\n    confidence?: number;\r\n    presentation?: string;\r\n  };\r\n\r\n  const successPayload: DetectionResponsePayload = {\r\n    status: \"success\",\r\n    verdict: structuredPayload.verdict,\r\n    score: structuredPayload.score,\r\n    confidence: structuredPayload.confidence,\r\n    presentation: structuredPayload.presentation,\r\n  };\r\n\r\n  console.log(LOG_PREFIX, \"Detection success:\", structuredPayload.verdict, \"score:\", structuredPayload.score);\r\n  recordTelemetry({\r\n    level: \"info\",\r\n    message: \"detection_success\",\r\n    details: { imageUrl, score: structuredPayload.score, verdict: structuredPayload.verdict },\r\n  });\r\n\r\n  cache.set(imageUrl, { timestamp: Date.now(), payload: successPayload });\r\n  dispatchResponse(imageUrl, successPayload);\r\n}\r\n\r\nasync function fetchImageBytes(url: string): Promise<Blob> {\r\n  const response = await fetch(url, {\r\n    method: \"GET\",\r\n    credentials: \"omit\",\r\n  });\r\n\r\n  if (!response.ok) {\r\n    throw new Error(`Unable to fetch image (${response.status})`);\r\n  }\r\n\r\n  const blob = await response.blob();\r\n  if (!blob || blob.size === 0) {\r\n    throw new Error(\"Image payload was empty.\");\r\n  }\r\n\r\n  return blob;\r\n}\r\n\r\nfunction extractFileName(url: string): string {\r\n  try {\r\n    const parsed = new URL(url);\r\n    const pieces = parsed.pathname.split(\"/\").filter(Boolean);\r\n    const lastSegment = pieces[pieces.length - 1];\r\n    return lastSegment || \"imagion-image.jpg\";\r\n  } catch {\r\n    return \"imagion-image.jpg\";\r\n  }\r\n}\r\n\r\nfunction dispatchResponse(imageUrl: string, payload: DetectionResponsePayload) {\r\n  const entry = pendingRequests.get(imageUrl);\r\n  if (!entry) {\r\n    return;\r\n  }\r\n  console.log(LOG_PREFIX, \"Dispatching response to\", entry.resolvers.length, \"resolver(s)\");\r\n  entry.resolvers.forEach(({ badgeId, sendResponse }) => {\r\n    sendResponse({ ...payload, badgeId, imageUrl });\r\n  });\r\n  pendingRequests.delete(imageUrl);\r\n}\r\n\r\nfunction parseRetryAfter(header: string | null): number {\r\n  if (!header) {\r\n    return BACKOFF_MIN_MS / 1000;\r\n  }\r\n  const parsed = Number.parseInt(header, 10);\r\n  if (Number.isFinite(parsed) && parsed > 0) {\r\n    return parsed;\r\n  }\r\n  return BACKOFF_MIN_MS / 1000;\r\n}\r\n\r\nfunction applyRateLimitBackoff(seconds: number) {\r\n  const waitMs = Math.min(Math.max(seconds * 1000, BACKOFF_MIN_MS), BACKOFF_MAX_MS);\r\n  nextAllowedTimestamp = Date.now() + waitMs;\r\n  if (backoffTimer) {\r\n    clearTimeout(backoffTimer);\r\n  }\r\n  backoffTimer = setTimeout(() => {\r\n    nextAllowedTimestamp = 0;\r\n    backoffTimer = null;\r\n    processQueue();\r\n  }, waitMs);\r\n}\r\n\r\nfunction recordTelemetry(entry: Omit<TelemetryEntry, \"timestamp\">) {\r\n  telemetryEntries.push({ timestamp: Date.now(), ...entry });\r\n  if (telemetryEntries.length > TELEMETRY_LIMIT) {\r\n    telemetryEntries.shift();\r\n  }\r\n  chrome.storage.local.set({ [TELEMETRY_KEY]: telemetryEntries });\r\n}\r\n"],"names":["LOG_PREFIX","DEFAULT_DETECTION_ENDPOINT","TELEMETRY_KEY","cache","pendingRequests","detectionQueue","telemetryEntries","runningDetections","cachedConfig","nextAllowedTimestamp","backoffTimer","getConfig","config","resolve","items","changes","areaName","message","_sender","sendResponse","handleImageDetection","normalizedUrl","normalizeImageUrl","cached","getCachedResult","existing","processQueue","imageUrl","pageUrl","error","entry","job","runDetection","imagionApiKey","imagionDetectionEndpoint","recordTelemetry","dispatchResponse","blob","fetchImageBytes","formData","fileName","extractFileName","file","response","payload","retryAfter","parseRetryAfter","applyRateLimitBackoff","structuredPayload","successPayload","url","pieces","badgeId","header","parsed","seconds","waitMs"],"mappings":"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"}