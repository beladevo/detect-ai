(function(){"use strict";const n="[Imagion Popup]",K="REQUEST_USAGE_STATUS",y="http://localhost:3000",P="/api/auth/extension",v=document.getElementById("view-loading"),w=document.getElementById("view-login"),D=document.getElementById("view-authenticated"),M=document.getElementById("login-form"),I=document.getElementById("email"),B=document.getElementById("password"),T=document.getElementById("login-btn"),h=document.getElementById("login-status"),b=document.getElementById("advanced-toggle"),A=document.getElementById("advanced-section"),U=document.getElementById("endpoint-input"),N=document.getElementById("user-email"),_=document.getElementById("user-tier"),R=document.getElementById("monthly-detections"),F=document.getElementById("total-detections"),O=document.getElementById("monthly-limit"),G=document.getElementById("daily-limit"),H=document.getElementById("api-key-display"),r=document.getElementById("copy-api-key"),p=document.getElementById("badge-toggle"),j=document.getElementById("logout-btn"),k=document.getElementById("register-link"),S=document.getElementById("forgot-link"),C=document.getElementById("dashboard-link"),V=document.getElementById("options-link");let c="",i=y;function d(t){switch(v.classList.remove("active"),w.classList.remove("active"),D.classList.remove("active"),t){case"loading":v.classList.add("active");break;case"login":w.classList.add("active");break;case"authenticated":D.classList.add("active");break}}function l(t,e){h.textContent=t,h.className=`status show ${e}`}function z(){h.className="status"}function m(t){T.disabled=t,T.innerHTML=t?'<span class="spinner"></span> Signing in...':"Sign In"}function J(t){return!t||t.length<20?t:`${t.substring(0,12)}...${t.substring(t.length-4)}`}function $(t){return t==null?"âˆž":t.toLocaleString()}async function E(){return new Promise(t=>{chrome.storage.local.get({imagionApiKey:"",imagionDetectionEndpoint:`${y}/api/detect`,imagionBadgeEnabled:!0,imagionUserEmail:"",imagionUserTier:"",imagionMonthlyDetections:0,imagionTotalDetections:0,imagionDailyDetections:0,imagionMonthlyLimit:null,imagionDailyLimit:null},e=>t(e))})}async function g(t){return new Promise(e=>{chrome.storage.local.set(t,()=>e())})}async function Q(){console.debug(n,"Checking auth status...");const t=await E();if(t.imagionDetectionEndpoint)try{const e=new URL(t.imagionDetectionEndpoint);i=`${e.protocol}//${e.host}`}catch{i=y}U.value=i,t.imagionApiKey?(console.info(n,"User is authenticated"),c=t.imagionApiKey,f(t),d("authenticated"),x()):(console.info(n,"User is not authenticated"),d("login"))}async function x(){if(c)return new Promise(t=>{chrome.runtime.sendMessage({type:K},async e=>{if(chrome.runtime.lastError){console.warn(n,"Usage status unavailable:",chrome.runtime.lastError.message),t();return}if(!e?.success||!e?.usage){t();return}const s=e.usage;await g({imagionMonthlyDetections:s.monthlyUsed,imagionDailyDetections:s.dailyUsed,imagionMonthlyLimit:s.monthlyLimit,imagionDailyLimit:s.dailyLimit,imagionTotalDetections:s.totalDetections});const u=await E();f(u),t()})})}function f(t){N.textContent=t.imagionUserEmail||"Unknown",_.textContent=t.imagionUserTier||"FREE",R.textContent=String(t.imagionMonthlyDetections||0),F.textContent=String(t.imagionTotalDetections||0),O.textContent=$(t.imagionMonthlyLimit),G.textContent=$(t.imagionDailyLimit),H.textContent=J(t.imagionApiKey||""),p.checked=t.imagionBadgeEnabled!==!1,k.href=`${i}/register`,S.href=`${i}/forgot-password`,C.href=`${i}/dashboard`}async function X(t){t.preventDefault(),z();const e=I.value.trim(),s=B.value,u=U.value.trim();if(!e||!s){l("Please enter email and password","error");return}if(u)try{const o=new URL(u);i=`${o.protocol}//${o.host}`}catch{l("Invalid endpoint URL","error");return}m(!0),console.info(n,"Attempting login for:",e);try{const o=await fetch(`${i}${P}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:s})}),a=await o.json();if(console.debug(n,"Auth response:",o.status,a.success),!o.ok||!a.success){l(a.error||"Authentication failed","error"),m(!1);return}if(!a.apiKey){l("No API key received","error"),m(!1);return}await g({imagionApiKey:a.apiKey,imagionDetectionEndpoint:`${i}/api/detect`,imagionUserEmail:a.user?.email||e,imagionUserTier:a.user?.tier||"FREE",imagionMonthlyDetections:a.user?.monthlyDetections||0,imagionTotalDetections:a.user?.totalDetections||0,imagionBadgeEnabled:!0}),c=a.apiKey,console.info(n,"Login successful, API key saved"),I.value="",B.value="";const tt=await E();f(tt),d("authenticated"),x()}catch(o){console.error(n,"Login error:",o),l(o instanceof Error?o.message:"Network error. Check your connection.","error")}finally{m(!1)}}async function q(){console.info(n,"Logging out..."),await g({imagionApiKey:"",imagionUserEmail:"",imagionUserTier:"",imagionMonthlyDetections:0,imagionTotalDetections:0,imagionDailyDetections:0,imagionMonthlyLimit:null,imagionDailyLimit:null}),c="",d("login")}async function W(){if(c)try{await navigator.clipboard.writeText(c);const t=r.textContent;r.textContent="Copied!",setTimeout(()=>{r.textContent=t},2e3)}catch(t){console.error(n,"Failed to copy:",t)}}async function Y(){const t=p.checked;console.debug(n,"Badge toggle:",t),await g({imagionBadgeEnabled:t})}function Z(){A.classList.toggle("show"),b.textContent=A.classList.contains("show")?"Hide advanced settings":"Advanced settings"}function L(t){chrome.tabs.create({url:t})}M.addEventListener("submit",X),j.addEventListener("click",q),r.addEventListener("click",W),p.addEventListener("change",Y),b.addEventListener("click",Z),k.addEventListener("click",t=>{t.preventDefault(),L(`${i}/register`)}),S.addEventListener("click",t=>{t.preventDefault(),L(`${i}/forgot-password`)}),C.addEventListener("click",t=>{t.preventDefault(),L(`${i}/dashboard`)}),V.addEventListener("click",t=>{t.preventDefault(),chrome.runtime.openOptionsPage()}),console.info(n,"Popup initialized"),Q()})();
//# sourceMappingURL=popup.js.map
